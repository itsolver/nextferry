<!-- to do: implement alternative routes to filter out the barge ferries (has no depart times in google) -->
<!DOCTYPE html>
<html>
  <head>
    <title>Next Ferry</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
          height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
          height: 100%;
          margin: 0;
          padding: 0;
        }
        #floating-panel {
          position: absolute;
          bottom: 10px;
          left: 25%;
          z-index: 5;
          background-color: #fff;
          padding: 5px;
          border: 1px solid #999;
          text-align: center;
          font-family: 'Roboto','sans-serif';
          line-height: 30px;
          padding-left: 10px;
        }
      </style>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
  <!-- <script src='polygons.js'></script> -->
  </head>
  <body>
    <div id="floating-panel">
    <label>From</label>
    <select id="start" name="start">
      <option value="-">-</option>
      <option value="Redland Bay Marina, Redland Bay QLD 4165">Redland Bay</option>
      <option value="Karragarra Ferry Terminal">Karragarra Island</option>
      <option value="Macleay Island Ferry Terminal">Macleay Island</option>
      <option value="Lamb Island Ferry Terminal">Lamb Island</option>
      <option value="Russell Island Ferry Terminal">Russell Island</option>
    </select>
    <br>
    <label>To</label>
    <select id="end" name="end">
      <option value="-">-</option>
      <option value="Macleay Island Ferry Terminal">Macleay Island</option>
      <option value="Redland Bay Marina, Redland Bay QLD 4165">Redland Bay</option>
      <option value="Karragarra Ferry Terminal">Karragarra Island</option>
      <option value="Lamb Island Ferry Terminal">Lamb Island</option>
      <option value="Russell Island Ferry Terminal">Russell Island</option>
    </select>
    <br>
    <button id="nextFerryButton">Next Ferry</button>
    <label>Departs</label>
    <span id="departs">-</span>
    <br>
    <label>Arrives</label>
    <span id="arrives">-</span>
    <!-- Add a button for next ferry -->
    </div>
    <div id="map"></div>
    <script>
      // Note: This example requires that you consent to location sharing when
      // prompted by your browser. If you see the error "The Geolocation service
      // failed.", it means you probably did not give permission for the browser to
      // locate you.
      var map, infoWindow, pos, pt, nearestTerminal, nearestTerminalPosition, departureTime;
      function initMap() {
        var directionsService = new google.maps.DirectionsService();
        var directionsDisplay = new google.maps.DirectionsRenderer();
        var redlandBayMarina = new google.maps.LatLng(-27.618050, 153.311496);

        map = new google.maps.Map(document.getElementById('map'), {
          center: redlandBayMarina,
          zoom: 12
        });
        infoWindow = new google.maps.InfoWindow;
        directionsDisplay.setMap(map)

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
           pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
          console.log("Current lat: " + pos.lat + ", lng: " + pos.lng);
          // Test variables
          //var testRedlandBayPoint = turf.point([153.3121453,-27.639948699999998]);
          //var testMacleayPoint = turf.point([153.3627793,-27.6224184]);
          pt = turf.point([pos.lng, pos.lat]);
          nearestTerminal = findNearestFerryTerminal(pt);
          document.getElementById('start').value = nearestTerminal;
          console.log('nearestTerminal: ' + nearestTerminal);
            
        }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
        var onChangeHandler = function() {
        var startTerminal = document.getElementById('start').value;
        var endTerminal = document.getElementById('end').value;
        window.departureTime = new Date();
        if (endTerminal != '-' && startTerminal != endTerminal) { 
          calculateAndDisplayRoute(window.departureTime, directionsService, directionsDisplay);
          } else {
            document.getElementById('end').value = "-";
          }
        };

        var nextFerryHandler = function() {
          var startTerminal = document.getElementById('start').value;
        var endTerminal = document.getElementById('end').value;
        if (endTerminal != '-' && startTerminal != endTerminal) { 
          minuteAfterNextDepartureTime = dateAdd(window.departureTime, 'minute', 1)
          console.log(minuteAfterNextDepartureTime);
          calculateAndDisplayRoute(minuteAfterNextDepartureTime, directionsService, directionsDisplay);
        } else {
            document.getElementById('end').value = "-";
          }
        };

        document.getElementById('start').addEventListener('change', onChangeHandler);
        document.getElementById('end').addEventListener('change', onChangeHandler);
        document.getElementById('nextFerryButton').addEventListener('click', nextFerryHandler);
      }

      function findNearestFerryTerminal(pt) {
        var pointInKarragarra = turf.booleanPointInPolygon(pt, polyKarragarra);
        var pointInMacleay = turf.booleanPointInPolygon(pt, polyMacleay);
        var pointInLamb = turf.booleanPointInPolygon(pt, polyLamb);
        var pointInRussell = turf.booleanPointInPolygon(pt, polyRussell);
        if (pointInKarragarra) {
          return "Karragarra Ferry Terminal";
        } else if (pointInMacleay) {
          return "Macleay Island Ferry Terminal";
        } else if (pointInLamb) {
          return "Lamb Island Ferry Terminal";
        } else if (pointInRussell) {
          return "Russell Island Ferry Terminal";
        } else {
          return "Redland Bay Marina, Redland Bay QLD 4165";
        }
      }

      function calculateAndDisplayRoute(departureTime, directionsService, directionsDisplay) {
        console.log(window);
        directionsService.route({
          origin: document.getElementById('start').value,
          destination: document.getElementById('end').value,
          travelMode: 'TRANSIT',
          transitOptions: {
          departureTime: departureTime,
          routingPreference: 'LESS_WALKING'
          },
          // alternatives: true
        }, function(response, status) {
          if (status === 'OK') {
            directionsDisplay.setDirections(response);
            // display departure and arrival time
            console.log('response.routes:');
            console.log(response.routes);
            console.log('Next ferry to ' + document.getElementById('end').value);
           if (typeof response.routes[0].legs[0].steps[0].transit !== 'undefined') {   // first route *step* is ferry, alt: response.routes[0].legs[0].steps[0].transit.line.name  === 'Bay Island Ferries'           
              document.getElementById('departs').innerHTML = response.routes[0].legs[0].steps[0].transit.departure_time.text;
              console.log('Departs: ' + response.routes[0].legs[0].steps[0].transit.departure_time.text);
              document.getElementById('arrives').innerHTML = response.routes[0].legs[0].steps[0].transit.arrival_time.text;
              console.log('Arrives: ' +  response.routes[0].legs[0].steps[0].transit.arrival_time.text);
              window.departureTime = new Date(response.routes[0].legs[0].steps[0].transit.departure_time.value);
            } else if (typeof response.routes[0].legs[0].steps[1].transit !== 'undefined') { // first route *step* is not ferry
            document.getElementById('departs').innerHTML = response.routes[0].legs[0].steps[1].transit.departure_time.text;
            console.log('Departs: ' + response.routes[0].legs[0].steps[1].transit.departure_time.text);
            document.getElementById('arrives').innerHTML = response.routes[0].legs[0].steps[1].transit.arrival_time.text;
            console.log('Arrives: ' +  response.routes[0].legs[0].steps[1].transit.arrival_time.text);
            window.departureTime = new Date(response.routes[0].legs[0].steps[1].transit.departure_time.value);
            } else if (typeof response.routes[0].legs[0].steps[0].transit.departure_time.text !== 'undefined') { // first route is not ferry
              window.alert('first route is not ferry');
            }
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Check location services are enabled.');
        infoWindow.open(map);
      }

       /**
       * Adds time to a date. Modelled after MySQL DATE_ADD function.
       * Example: dateAdd(new Date(), 'minute', 30)  //returns 30 minutes from now.
       * https://stackoverflow.com/a/1214753/18511
       * 
       * @param date  Date to start with
       * @param interval  One of: year, quarter, month, week, day, hour, minute, second
       * @param units  Number of units of the given interval to add.
       */
      function dateAdd(date, interval, units) {
        var ret = new Date(date); //don't change original date
        var checkRollover = function() { if(ret.getDate() != date.getDate()) ret.setDate(0);};
        switch(interval.toLowerCase()) {
          case 'year'   :  ret.setFullYear(ret.getFullYear() + units); checkRollover();  break;
          case 'quarter':  ret.setMonth(ret.getMonth() + 3*units); checkRollover();  break;
          case 'month'  :  ret.setMonth(ret.getMonth() + units); checkRollover();  break;
          case 'week'   :  ret.setDate(ret.getDate() + 7*units);  break;
          case 'day'    :  ret.setDate(ret.getDate() + units);  break;
          case 'hour'   :  ret.setTime(ret.getTime() + units*3600000);  break;
          case 'minute' :  ret.setTime(ret.getTime() + units*60000);  break;
          case 'second' :  ret.setTime(ret.getTime() + units*1000);  break;
          default       :  ret = undefined;  break;
        }
        return ret;
      }
      var polyKarragarra = turf.polygon([[
    [
              153.359956741333,
              -27.635900316345825
            ],
            [
              153.35965633392334,
              -27.63677475597565
            ],
            [
              153.36420536041257,
              -27.639588123027757
            ],
            [
              153.37909698486328,
              -27.643047704955872
            ],
            [
              153.38682174682617,
              -27.63962614100607
            ],
            [
              153.38527679443357,
              -27.638447577535935
            ],
            [
              153.37896823883057,
              -27.638257485464756
            ],
            [
              153.37514877319336,
              -27.636204470053094
            ],
            [
              153.37090015411377,
              -27.635063889291835
            ],
            [
              153.36133003234863,
              -27.63498785015174
            ],
            [
              153.359956741333,
              -27.635900316345825
            ]
      ]]);
    
    var polyMacleay = turf.polygon([[
        [
          153.36081360914454,
          -27.57974950492049
        ],
        [
          153.35652207472071,
          -27.583020789199452
        ],
        [
          153.35308884718165,
          -27.5916169548565
        ],
        [
          153.34845399000392,
          -27.602494322291054
        ],
        [
          153.34622239210353,
          -27.622648827289204
        ],
        [
          153.3616719160293,
          -27.63314291220224
        ],
        [
          153.36785172559962,
          -27.6313939679145
        ],
        [
          153.37351655103907,
          -27.624778143259334
        ],
        [
          153.37325905897364,
          -27.620443420664976
        ],
        [
          153.3766922865127,
          -27.619378725707083
        ],
        [
          153.37686394788966,
          -27.61740140760731
        ],
        [
          153.37334488966212,
          -27.60933966435684
        ],
        [
          153.36802338697657,
          -27.587889496746563
        ],
        [
          153.36450432874904,
          -27.581651426257483
        ],
        [
          153.36081360914454,
          -27.57974950492049
        ]
      ]]);

      var polyLamb = turf.polygon([[
      [
              153.37231636047363,
              -27.63088165812855
            ],
            [
              153.3746337890625,
              -27.630995721098323
            ],
            [
              153.37562084197998,
              -27.630311341496633
            ],
            [
              153.37828159332275,
              -27.63206030308418
            ],
            [
              153.38604927062988,
              -27.627725868828303
            ],
            [
              153.38587760925293,
              -27.623315215692106
            ],
            [
              153.38995456695557,
              -27.62042538108522
            ],
            [
              153.3842897415161,
              -27.61597640767686
            ],
            [
              153.38244438171387,
              -27.617193238873263
            ],
            [
              153.38162899017334,
              -27.620843651341023
            ],
            [
              153.3753204345703,
              -27.620767602322445
            ],
            [
              153.37364673614502,
              -27.622022404375002
            ],
            [
              153.37364673614502,
              -27.62495021990858
            ],
            [
              153.37257385253906,
              -27.626927401692058
            ],
            [
              153.37231636047363,
              -27.63088165812855
            ]
      ]]);

      var polyRussell = turf.polygon([[
            [
              153.41626167297366,
              -27.64226835813398
            ],
            [
              153.41737747192383,
              -27.641146849305667
            ],
            [
              153.40244293212893,
              -27.636128431705547
            ],
            [
              153.40175628662112,
              -27.642211332538775
            ],
            [
              153.3974647521973,
              -27.644188202492437
            ],
            [
              153.3904266357422,
              -27.640842709336688
            ],
            [
              153.38871002197266,
              -27.642667536468046
            ],
            [
              153.38922500610354,
              -27.645404720092113
            ],
            [
              153.3826160430908,
              -27.644568365695655
            ],
            [
              153.37051391601565,
              -27.64510059196055
            ],
            [
              153.36399078369143,
              -27.652399433726853
            ],
            [
              153.36523532867434,
              -27.67041636337859
            ],
            [
              153.36725234985354,
              -27.67296282062129
            ],
            [
              153.36948394775393,
              -27.6730768397067
            ],
            [
              153.3732604980469,
              -27.669580200296554
            ],
            [
              153.37703704833987,
              -27.672772788547903
            ],
            [
              153.37635040283206,
              -27.677637505548102
            ],
            [
              153.37240219116214,
              -27.680525828768506
            ],
            [
              153.36416244506836,
              -27.69496629909567
            ],
            [
              153.36725234985354,
              -27.702565779458812
            ],
            [
              153.37411880493167,
              -27.70758114660114
            ],
            [
              153.38510513305667,
              -27.71016473060811
            ],
            [
              153.39076995849612,
              -27.705605423429617
            ],
            [
              153.39420318603518,
              -27.697854163968913
            ],
            [
              153.39832305908203,
              -27.697854163968913
            ],
            [
              153.39883804321292,
              -27.6954222828395
            ],
            [
              153.39591979980472,
              -27.69131836057304
            ],
            [
              153.3945465087891,
              -27.684782165876676
            ],
            [
              153.3930015563965,
              -27.664106974852885
            ],
            [
              153.38939666748047,
              -27.65787324537484
            ],
            [
              153.39591979980472,
              -27.654528170818764
            ],
            [
              153.3978939056397,
              -27.6526275146832
            ],
            [
              153.39900970458984,
              -27.650118597999654
            ],
            [
              153.4026145935059,
              -27.648750073730046
            ],
            [
              153.40604782104495,
              -27.64327580541439
            ],
            [
              153.41068267822268,
              -27.643884070978643
            ],
            [
              153.4130859375,
              -27.643579938619272
            ],
            [
              153.41626167297366,
              -27.64226835813398
            ]
      ]]);
    </script>
    <!-- production Google Cloud API key -->
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBw63UBGjbDz967BRrc5gRO2DH59eGZkFs&callback=initMap">
    </script>
    <!-- test Google Cloud API key -->
    <!-- <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAuhwi-ZslvLs6D2I2JpH-HtruYukcWWnU&callback=initMap">
    </script> -->
  </body>
</html>